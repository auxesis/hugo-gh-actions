name: Screenshot PR changes

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  preflight:
    name: ü§î Screenshot needed?
    runs-on: ubuntu-latest
    outputs:
      slug_matrix: ${{ steps.article_names.outputs.slug_matrix }}
    steps:
    - name: üõí Checkout repo
      uses: actions/checkout@v2

    - name: üîé Identify file changes
      id: file_changes
      uses: trilom/file-changes-action@v1.2.3
      with:
        prNumber: ${{ github.event.pull_request.number }}

    - name: üïµÔ∏è Any articles?
      id: any_articles
      run: |
        echo -n "::set-output name=count::"
        jq --slurp '.[0] + .[1] | unique | map(select(. | test("^articles\/"))) | length' ~/files_added.json ~/files_modified.json

    - name: üöß Stop if no article changes
      if: steps.any_articles.outputs.count == 0
      uses: andymckay/cancel-action@0.2

    - name: üïµÔ∏è Identify article names
      id: article_names
      run: |
        echo -n "::set-output name=slug_matrix::"
        jq --slurp --compact-output '.[0] + .[1] | unique | map(select(. | test("^articles\/"))) | map(. | split("/")[1] | { article_slug: . }) | { include: . }' ~/files_added.json ~/files_modified.json

  build:
    name: üåç Build the website
    runs-on: ubuntu-latest
    if: false
    needs: [ preflight ]
    steps:
    - name: üõí Checkout repo
      uses: actions/checkout@v2
      with:
        repository: ${{ secrets.WEBSITE_REPO }}
        ref: add-entrypoint-to-dockerfile # FIXME(auxesis) change to master when merged
        token: ${{ secrets.ACCESS_TOKEN }}
        submodules: false

    - name: üîÄ Change to PR branch
      run: |
        git config -f .gitmodules submodule.eng-ed.url https://github.com/${{ github.repository }}
        git config -f .gitmodules submodule.eng-ed.branch ${{ github.head_ref }}
        git submodule sync
        git submodule update --init --remote --force

    - name: üõ† Build, Tag, Push
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: auxesis/section-gh-action-www.section.io
        tags: latest

  screenshot:
    name: üì∏ Take screenshot
    needs: [ preflight ]
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.preflight.outputs.slug_matrix) }}
    services:
      website:
        image: registry.hub.docker.com/auxesis/section-gh-action-www.section.io:latest
        ports:
          - 1313:1313
    steps:

    - name: ‚è≥ Wait for Hugo to serve
      run: |
        npm install wait-port
        $(npm bin)/wait-port --timeout 45000 http://localhost:1313/

    - name: üì∏ Screenshot Website
      id: screenshot_website
      uses: swinton/screenshot-website@v1.0.0
      timeout-minutes: 2
      with:
        source: http://localhost:1313/engineering-education/${{ matrix.article_slug }}/
        destination: screenshot-${{ matrix.article_slug }}.png # FIXME(auxesis) lookup variable name
        full-page: true

    - name: ‚òÅÔ∏è  Upload screenshot
      id: upload-screenshot
      env:
        UPLOAD_RESPONSE_FILENAME: kraken-upload-screenshot-${{ matrix.article_slug }}-response.json
      run: |
        curl https://api.kraken.io/v1/upload \
        -X POST \
        --output $UPLOAD_RESPONSE_FILENAME \
        --form data='{"auth":{"api_key": "${{ secrets.KRAKEN_API_KEY }}", "api_secret": "${{ secrets.KRAKEN_API_SECRET }}"}, "wait":true, "lossy":true}' \
        --form upload=@${{ steps.screenshot_website.outputs.path }}
        if ! grep -c '^{' $UPLOAD_RESPONSE_FILENAME; then
          cat $UPLOAD_RESPONSE_FILENAME
          exit 1
        fi
        echo -n "::set-output name=img_url::"
        jq --raw-output '.kraked_url' $UPLOAD_RESPONSE_FILENAME
    - name: üó£ Post comment
      uses: actions/github-script@v2
      with:
        script: |
          args = {
            issue_number: context.payload.pull_request.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "Here's a screenshot of the article:\n\n![screenshot](${{ steps.upload-screenshot.outputs.img_url }})"
          }
          github.issues.createComment(args)
