name: Screenshot PR changes

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  preflight:
    name: 🤔 Screenshot needed?
    runs-on: ubuntu-latest
    outputs:
      slug_matrix: ${{ steps.article_names.outputs.slug_matrix }}
    steps:
    - name: 🛒 Checkout repo
      uses: actions/checkout@v2

    - name: 🔎 Identify file changes
      id: file_changes
      uses: trilom/file-changes-action@v1.2.3
      with:
        prNumber: ${{ github.event.pull_request.number }}

    - name: 🕵️ Any articles?
      id: any_articles
      run: |
        echo -n "::set-output name=count::"
        jq --slurp '.[0] + .[1] | unique | map(select(. | test("^articles\/"))) | length' ~/files_added.json ~/files_modified.json

    - name: 🚧 Stop if no article changes
      if: steps.any_articles.outputs.count == 0
      uses: andymckay/cancel-action@0.2

    - name: 🕵️ Identify article names
      id: article_names
      run: |
        echo -n "::set-output name=slug_matrix::"
        jq --slurp --compact-output '.[0] + .[1] | unique | map(select(. | test("^articles\/"))) | map(. | split("/")[1] | { article_slug: . }) | { include: . }' ~/files_added.json ~/files_modified.json

  build:
    name: 🌍 Build the website
    runs-on: ubuntu-latest
    if: false
    needs: [ preflight ]
    steps:
    - name: 🛒 Checkout repo
      uses: actions/checkout@v2
      with:
        repository: ${{ secrets.WEBSITE_REPO }}
        ref: add-entrypoint-to-dockerfile # FIXME(auxesis) change to master when merged
        token: ${{ secrets.ACCESS_TOKEN }}
        submodules: false

    - name: 🔀 Change to PR branch
      run: |
        git config -f .gitmodules submodule.eng-ed.url https://github.com/${{ github.repository }}
        git config -f .gitmodules submodule.eng-ed.branch ${{ github.head_ref }}
        git submodule sync
        git submodule update --init --remote --force

    - name: 🛠 Build, Tag, Push
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: auxesis/section-gh-action-www.section.io
        tags: latest

  screenshot:
    name: 📸 Take screenshot
    needs: [ preflight ]
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.preflight.outputs.slug_matrix) }}
    services:
      website:
        image: registry.hub.docker.com/auxesis/section-gh-action-www.section.io:latest
        ports:
          - 1313:1313
    steps:
    - name: ⏳ Wait for Hugo to serve
      run: |
        npm install wait-port
        $(npm bin)/wait-port --timeout 45000 http://localhost:1313/
    - name: 📸 Screenshot Website
      uses: swinton/screenshot-website@v1.0.0
      timeout-minutes: 2
      with:
        source: http://localhost:1313/engineering-education/${{ matrix.article_slug }}/
        destination: screenshot-${{ matrix.article_slug }}.png
        full-page: true
    - name: ☁️  Upload screenshot
      id: upload-screenshot
      env:
        IMG_FILENAME: screenshot-${{ matrix.article_slug }}.png
        UPLOAD_RESPONSE_FILENAME: kraken-screenshot-${{ matrix.article_slug }}-response.json
      run: >
        curl https://api.kraken.io/v1/upload
        -X POST
        --output $UPLOAD_RESPONSE_FILENAME
        --form data='{"auth":{"api_key": "${{ secrets.KRAKEN_API_KEY }}", "api_secret": "${{ secrets.KRAKEN_API_SECRET }}"}, "wait":true, "lossy":true}'
        --form upload=$IMG_FILENAME
     - name: 🗣 Post comment
       run: |
         cat $UPLOAD_RESPONSE_FILENAME
         echo $${ steps.upload-screenshot.outputs.img_url }}
