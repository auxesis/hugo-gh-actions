name: Screenshot PR changes

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
#  build:
#    name: ðŸ•¸ Build the website
#    runs-on: ubuntu-latest
#    steps:
#    - name: ðŸ›’ Checkout repo
#      uses: actions/checkout@v2
#      with:
#        repository: ${{ secrets.WEBSITE_REPO }}
#        ref: add-entrypoint-to-dockerfile
#        token: ${{ secrets.ACCESS_TOKEN }}
#        submodules: true
#    - name: ðŸ›  Build, Tag, Push
#      uses: docker/build-push-action@v1
#      with:
#        username: ${{ secrets.DOCKER_USERNAME }}
#        password: ${{ secrets.DOCKER_PASSWORD }}
#        repository: auxesis/section-gh-action-www.section.io
#        tags: latest

  screenshot:
    name: ðŸ“¸ Screenshot the website
    #needs: build
    runs-on: ubuntu-latest
    services:
      website:
        image: registry.hub.docker.com/auxesis/section-gh-action-www.section.io:latest
        ports:
          - 1313:1313
    steps:
    - name: ðŸ›’ Checkout repo
      uses: actions/checkout@v2
    - name: ðŸ”Ž Get PR details
      uses: actions/github-script@0.6.0
        id: pr
        with:
          github-token: ${{env.BOT_USER_TOKEN}}
          result-encoding: string
          script: |
            const result = await github.repos.listPullRequestsAssociatedWithCommit({
              owner: context.payload.repository.owner.name,
              repo: context.payload.repository.name,
              commit_sha: context.payload.head_commit.id
            })
            return result.data[0].number;
    - id: file_changes
      uses: trilom/file-changes-action@v1.2.3
      with:
        githubToken: ${{ env.BOT_USER_TOKEN }}
        prNumber: ${{ steps.pr.outputs.results }}
        output: ' '
        fileOutput: ' '
    - uses: actions/upload-artifact@v2
      with:
        name: file-changes
        path: '~/*.json'
    - name: ðŸ“¸ Screenshot Website
      uses: swinton/screenshot-website@v1.0.0
      with:
        source: http://localhost:1313/
        destination: screenshot.png
        full-page: true
