name: Screenshot PR changes

on:
  issue_comment:
    types: [ created ]
#  pull_request:
#    types: [ opened, synchronize, reopened ]
#    branches: [ master ]

jobs:
  preflight:
    name: ðŸ›« Do we need a screenshot?
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ›’ Checkout repo
      uses: actions/checkout@v2
    - name: Dump github
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: ï¿½ Get PR details
      uses: actions/github-script@0.6.0
      id: pr
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        result-encoding: string
        script: |
          console.log(context.payload)

          const result = await github.repos.listPullRequestsAssociatedWithCommit({
            owner: context.payload.repository.owner.name,
            repo: context.payload.repository.name,
            commit_sha: context.payload.after
          });

          console.log(result);

          return result.data[0].number;

    - name: Identify file changes
      id: file_changes
      uses: trilom/file-changes-action@v1.2.3
      with:
        githubToken: ${{ secrets.GITHUB_TOKEN }}
        prNumber: ${{ github.event.pull_request.number }}
        output: ' '
        fileOutput: ' '
    - uses: actions/upload-artifact@v2
      with:
        name: file-changes
        path: '~/*.json'
    - name: ðŸš§ Stop execution
      run: exit 1

  build:
    name: ðŸ•¸ Build the website
    runs-on: ubuntu-latest
    needs: [ preflight ]
    steps:
    - name: ðŸ›’ Checkout repo
      uses: actions/checkout@v2
      with:
        repository: ${{ secrets.WEBSITE_REPO }}
        ref: add-entrypoint-to-dockerfile
        token: ${{ secrets.ACCESS_TOKEN }}
        submodules: true
    - name: ðŸ›   Build, Tag, Push
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: auxesis/section-gh-action-www.section.io
        tags: latest

  screenshot:
    name: ðŸ“¸ Screenshot the website
    needs: [ preflight, build ]
    runs-on: ubuntu-latest
    services:
      website:
        image: registry.hub.docker.com/auxesis/section-gh-action-www.section.io:latest
        ports:
          - 1313:1313
    steps:
    - name: ðŸ“¸ Screenshot Website
      uses: swinton/screenshot-website@v1.0.0
      with:
        source: http://localhost:1313/
        destination: screenshot.png
        full-page: true
