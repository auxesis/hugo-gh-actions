name: Screenshot PR changes

on:
#  issue_comment:
#    types: [ created ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  preflight:
    name: 🛫 Screenshot needed?
    runs-on: ubuntu-latest
    steps:
    - name: 🛒 Checkout repo
      uses: actions/checkout@v2
    - name: Dump github
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: 🔎 Identify file changes
      id: file_changes
      uses: trilom/file-changes-action@v1.2.3
      with:
        prNumber: ${{ github.event.pull_request.number }}

    - name: ⬆️  Upload file changes
      uses: actions/upload-artifact@v2
      with:
        name: file-changes
        path: ~/*.json

    - name: 🚧 Stop execution if no article changes
      run: jq --exit-status --slurp '.[0] + .[1] | unique | map(select(. | test("^articles\/"))) | length > 0' ~/files_added.json ~/files_modified.json

  build:
    name: 🕸 Build the website
    runs-on: ubuntu-latest
    needs: [ preflight ]
    steps:
    - name: 🛒 Checkout repo
      uses: actions/checkout@v2
      with:
        repository: ${{ secrets.WEBSITE_REPO }}
        ref: add-entrypoint-to-dockerfile # FIXME(auxesis) change to master when merged
        token: ${{ secrets.ACCESS_TOKEN }}
        submodules: true
    - run: 🔀 Change to PR branch
      run: cd content/engineering-education && git checkout ${{ github.head_ref }}
    - name: 🛠 Build, Tag, Push
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: auxesis/section-gh-action-www.section.io
        tags: latest

  screenshot:
    name: 📸 Screenshot the website
    needs: [ preflight, build ]
    runs-on: ubuntu-latest
    services:
      website:
        image: registry.hub.docker.com/auxesis/section-gh-action-www.section.io:latest
        ports:
          - 1313:1313
    steps:
    - name: 📸 Screenshot Website
      uses: swinton/screenshot-website@v1.0.0
      with:
        source: http://localhost:1313/
        destination: screenshot.png
        full-page: true
